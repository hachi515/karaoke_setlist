
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Karaoke Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS内の括弧は { } でエスケープ */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --header-bg: #fff;
            --border-color: #e0e0e0;
        }
        html, body {
            height: 100%; margin: 0; padding: 0;
            overflow: hidden; 
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 13px; 
            display: flex; flex-direction: column;
        }

        /* --- ダッシュボード(Live)用スタイル: リンク無効化・レイアウト保持 --- */
        
        /* Analysis: リンクタグをただのテキストのように見せる */
        a.export-link {
            color: inherit;
            text-decoration: none;
            pointer-events: none; /* クリック無効 */
            cursor: default;
        }

        /* Ranking: ダッシュボードでは行クリック無効 */
        tr.ranking-row {
            cursor: default; 
        }
        
        /* レイアウト: デフォルトのテーブル挙動に戻しつつ、min-widthはインラインスタイルで適用済み */
        th, td {
            padding: 5px 8px; text-align: left; border-bottom: 1px solid #eee;
            font-size: 13px; vertical-align: middle; line-height: 1.3;
        }
        th {
            background-color: var(--primary-color); color: #fff;
            position: sticky; top: 0; z-index: 10; font-weight: bold;
        }

        .top-section {
            flex: 0 0 auto;
            background-color: var(--header-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .header-inner {
            padding: 8px 15px; display: flex; justify-content: space-between; align-items: center;
        }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary-color); }
        .update-time { font-size: 0.8rem; color: #7f8c8d; }

        .tabs {
            display: flex; padding: 0 15px; border-bottom: 1px solid var(--border-color);
        }
        .tab-btn {
            padding: 10px 20px; cursor: pointer; border: none; background: none;
            font-weight: bold; color: #7f8c8d; border-bottom: 3px solid transparent;
            font-size: 14px;
        }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }

        .controls-row {
            padding: 8px 15px; display: flex; gap: 8px; align-items: center;
            background-color: #fff; border-bottom: 1px solid var(--border-color);
            height: 40px; 
        }
        .search-box {
            padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px;
            width: 250px; font-size: 13px; outline: none;
        }
        .btn {
            padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer;
            color: #fff; background-color: var(--accent-color); font-size: 13px;
            font-weight: bold; white-space: nowrap;
        }
        .btn:hover { opacity: 0.9; }
        .btn-dl { background-color: #2ecc71; }
        .count-display { margin-left: auto; font-weight: bold; font-size: 13px; }

        .ctrl-setlist { display: flex; width: 100%; align-items: center; gap:8px; }
        .ctrl-analysis { display: none; width: 100%; align-items: center; justify-content: flex-end; }
        .ctrl-ranking { display: none; width: 100%; align-items: center; justify-content: flex-end; }

        .content-area {
            flex: 1; position: relative; overflow: hidden; 
        }
        .tab-content {
            display: none; position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding: 0 15px 40px 15px;
        }
        .tab-content.active { display: block; }

        table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            background: #fff; border-radius: 4px; margin-top: 10px; margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f1f8ff; }
        tr.hidden { display: none !important; }

        .category-header {
            margin-top: 20px; padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 6px;
            font-weight: bold; font-size: 1.1rem; cursor: pointer;
            user-select: none;
        }
        .category-content { display: block; transition: all 0.3s; }
        .category-content.collapsed { display: none; }
        
        /* 作成数0のグレーアウト */
        .gray-text { color: gray !important; }
        tr.zero-count { color: #ccc; }
        
        /* ★保存版用スタイル: リンク有効化 */
        /* ネガティブマージンでセル全体をクリック可能にする */
        a.export-link {
            display: block; 
            margin: -5px -8px; 
            padding: 5px 8px;  
            color: #333; 
            text-decoration: none; 
            box-sizing: border-box;
            cursor: pointer;
        }
        a.export-link:hover { background-color: #eef2f7; color: #3498db; }
        
        /* ランキング: 行ホバー */
        tr.ranking-row { cursor: pointer; }
        tr.ranking-row:hover { background-color: #dbeafe; }
        
        .count-wrapper { display: flex; align-items: center; gap: 8px; }
        .count-num { width: 25px; text-align: right; }
        .bar-chart { height: 10px; background: #3498db; border-radius: 5px; }
        
        .rank-badge {
            display: inline-block; width: 24px; height: 24px; line-height: 24px;
            border-radius: 50%; text-align: center; color: #fff; font-weight: bold; font-size: 12px;
            background-color: #95a5a6;
        }
        .rank-1 { background-color: #f1c40f; width: 28px; height: 28px; line-height: 28px; }
        .rank-2 { background-color: #bdc3c7; }
        .rank-3 { background-color: #d35400; }
        .rankingTable tr:nth-child(1) td { background-color: #fffae6; }
        .rankingTable tr:nth-child(2) td { background-color: #f8f9fa; }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            .category-content { display: block !important; }
            tbody.anime-group { break-inside: avoid; page-break-inside: avoid; }
            .category-header { page-break-after: avoid; }
            thead { display: table-header-group; }
        }
    </style>
</head>
<body>
    <h1>${title}</h1>
    <div style="text-align:right; font-size:0.9rem; color:#777;">出力日: 2026/01/17</div>
    ${content}

    <script>
        // ★ リンク先ホスト (ここを1箇所変更するだけで全リンクに適用)
        const host = 'http://ykr.moe:11059';

        // ランキング行クリック機能 (保存版でのみ有効)
        function onRankingClick(row) {
            if (window.getSelection().toString().length > 0) return;
            
            const rawHref = row.getAttribute('data-href');
            if (rawHref && rawHref.startsWith('#host')) {
                const url = rawHref.replace('#host', host);
                window.open(url, '_blank');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            // クール集計のリンク(Aタグ) href置換
            document.querySelectorAll('a.export-link').forEach(link => {
                const rawHref = link.getAttribute('href');
                if (rawHref && rawHref.startsWith('#host')) {
                    link.href = rawHref.replace('#host', host);
                }
            });
        });

        function toggleCategory(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
            const icon = header.querySelector('i');
            if(icon) {
                icon.className = content.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-down';
                icon.style.float = 'right';
            }
        }

        // クール集計のダウンロード
        function downloadHTML() {
            const element = document.getElementById('print-target');
            const htmlContent = element.innerHTML;
            generateDownload(htmlContent, 'karaoke_analysis.html', 'クール集計結果');
        }

        // ランキングのダウンロード
        function downloadRanking() {
            const element = document.getElementById('ranking-print-target');
            const htmlContent = element.innerHTML;
            generateDownload(htmlContent, 'karaoke_ranking.html', 'カラオケ歌唱ランキング');
        }

        // ダウンロード共通処理
        function generateDownload(content, filename, title) {
            const fullHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; font-size: 13px; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 5px 8px; text-align: left; vertical-align: middle; }
        th { background-color: #2c3e50; color: #fff; }
        td[rowspan] { background-color: #fff; }
        
        .category-header { 
            background: #667eea; color: white; padding: 10px; margin-top: 20px; 
            font-weight: bold; border-radius: 4px; cursor: pointer; user-select: none;
        }
        .category-content { display: block; }
        .category-content.collapsed { display: none; }
        
        /* 作成数0のグレーアウト */
        .gray-text { color: gray !important; }
        tr.zero-count { color: #ccc; }
        
        /* ★保存版用スタイル: リンク有効化 */
        /* ネガティブマージンでセル全体をクリック可能にする */
        a.export-link {
            display: block; 
            margin: -5px -8px; 
            padding: 5px 8px;  
            color: #333; 
            text-decoration: none; 
            box-sizing: border-box;
            cursor: pointer;
        }
        a.export-link:hover { background-color: #eef2f7; color: #3498db; }
        
        /* ランキング: 行ホバー */
        tr.ranking-row { cursor: pointer; }
        tr.ranking-row:hover { background-color: #dbeafe; }
        
        .count-wrapper { display: flex; align-items: center; gap: 8px; }
        .count-num { width: 25px; text-align: right; }
        .bar-chart { height: 10px; background: #3498db; border-radius: 5px; }
        
        .rank-badge {
            display: inline-block; width: 24px; height: 24px; line-height: 24px;
            border-radius: 50%; text-align: center; color: #fff; font-weight: bold; font-size: 12px;
            background-color: #95a5a6;
        }
        .rank-1 { background-color: #f1c40f; width: 28px; height: 28px; line-height: 28px; }
        .rank-2 { background-color: #bdc3c7; }
        .rank-3 { background-color: #d35400; }
        .rankingTable tr:nth-child(1) td { background-color: #fffae6; }
        .rankingTable tr:nth-child(2) td { background-color: #f8f9fa; }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            .category-content { display: block !important; }
            tbody.anime-group { break-inside: avoid; page-break-inside: avoid; }
            .category-header { page-break-after: avoid; }
            thead { display: table-header-group; }
        }
    </style>
</head>
<body>
    <h1>${title}</h1>
    <div style="text-align:right; font-size:0.9rem; color:#777;">出力日: 2026/01/17</div>
    ${content}

    <script>
        // ★ リンク先ホスト (ここを1箇所変更するだけで全リンクに適用)
        const host = 'http://ykr.moe:11059';

        // ランキング行クリック機能 (保存版でのみ有効)
        function onRankingClick(row) {
            if (window.getSelection().toString().length > 0) return;
            
            const rawHref = row.getAttribute('data-href');
            if (rawHref && rawHref.startsWith('#host')) {
                const url = rawHref.replace('#host', host);
                window.open(url, '_blank');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            // クール集計のリンク(Aタグ) href置換
            document.querySelectorAll('a.export-link').forEach(link => {
                const rawHref = link.getAttribute('href');
                if (rawHref && rawHref.startsWith('#host')) {
                    link.href = rawHref.replace('#host', host);
                }
            });
        });

        function toggleCategory(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
            const icon = header.querySelector('i');
            if(icon) {
                icon.className = content.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-down';
                icon.style.float = 'right';
            }
        }
    <\/script>
</body>
</html>`;

            const blob = new Blob([fullHtml], {type: 'text/html'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
    </script>
    <script>
        const searchInput = document.getElementById("searchInput");
        const table = document.getElementById("setlistTable");
        const countDisplay = document.getElementById('countDisplay');
        let tableData = [];
        let tbodyRows = [];

        window.addEventListener('DOMContentLoaded', () => {
            const tbody = table.tBodies[0];
            if (tbody) {
                tbodyRows = Array.from(tbody.rows);
                tableData = tbodyRows.map(row => row.innerText.toUpperCase());
                countDisplay.innerText = '全 ' + tbodyRows.length + ' 件';
            }
        });

        searchInput.addEventListener("keyup", function(event) {
            if (event.key === "Enter") performSearch();
        });

        function performSearch() {
            const filter = searchInput.value.toUpperCase();
            const keywords = filter.replace(/　/g, " ").split(" ").filter(k => k.length > 0);
            let visibleCount = 0;
            const total = tableData.length;
            
            for (let i = 0; i < total; i++) {
                let isMatch = true;
                const rowText = tableData[i];
                for (let k = 0; k < keywords.length; k++) {
                    if (rowText.indexOf(keywords[k]) === -1) {
                        isMatch = false; break;
                    }
                }
                
                if (isMatch || keywords.length === 0) {
                    tbodyRows[i].classList.remove('hidden');
                    visibleCount++;
                } else {
                    tbodyRows[i].classList.add('hidden');
                }
            }
            countDisplay.innerText = '表示: ' + visibleCount + ' / ' + total;
        }

        function resetFilter() {
            searchInput.value = "";
            performSearch();
        }

        function sortTable(n) {
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const th = table.querySelectorAll('th')[n];
            let dir = th.getAttribute('data-dir') === 'asc' ? 'desc' : 'asc';
            
            table.querySelectorAll('th').forEach(h => h.setAttribute('data-dir', ''));
            th.setAttribute('data-dir', dir);

            rows.sort((a, b) => {
                const valA = a.cells[n].innerText.trim();
                const valB = b.cells[n].innerText.trim();
                if (!isNaN(valA) && !isNaN(valB) && valA!=='' && valB!=='') {
                    return dir === 'asc' ? valA - valB : valB - valA;
                }
                return dir === 'asc' ? valA.localeCompare(valB,'ja') : valB.localeCompare(valA,'ja');
            });
            rows.forEach(row => tbody.appendChild(row));
            tbodyRows = rows;
            tableData = tbodyRows.map(row => row.innerText.toUpperCase());
        }
    </script>
</body>
</html>
